


    <title>mariadb-query-digest &mdash; MariaDB Tools Documentation</title>
    
  <head>
    
    
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="MariaDB Tools Documentation" href="index.html" />
    <link rel="next" title="mariadb-schema-change" href="mariadb-schema-change.html" />
    <link rel="prev" title="mariadb-kill" href="mariadb-kill.html" /> 
  </head>
  <body>
    <div class="container">  

    <div class="document row">
      <div class="documentwrapper col-md-9 col-md-push-3">
    <div class="related row">
      
      <ul class="nav nav-pills">
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="mariadb-schema-change.html" title="mariadb-schema-change"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="mariadb-kill.html" title="mariadb-kill"
             accesskey="P">previous</a></li>
        <li><a href="index.html">MariaDB Tools</a></li> 
      </ul>
    </div>
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mariadb-query-digest">
<h1><strong class="program">mariadb-query-digest</strong><a class="headerlink" href="#mariadb-query-digest" title="Permalink to this headline">¶</a></h1>
<div class="section" id="name">
<h2>NAME<a class="headerlink" href="#name" title="Permalink to this headline">¶</a></h2>
<p><strong class="program">mariadb-query-digest</strong> - Analyze MariaDB queries from logs, processlist, and tcpdump.</p>
</div>
<div class="section" id="synopsis">
<h2>SYNOPSIS<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mariadb</span><span class="o">-</span><span class="n">query</span><span class="o">-</span><span class="n">digest</span> <span class="p">[</span><span class="n">OPTIONS</span><span class="p">]</span> <span class="p">[</span><span class="n">FILES</span><span class="p">]</span> <span class="p">[</span><span class="n">DSN</span><span class="p">]</span>
</pre></div>
</div>
<p><strong class="program">mariadb-query-digest</strong> analyzes MariaDB queries from slow, general, and binary log
files.  It can also analyze queries from <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROCESSLIST</span></code> and MariaDB
protocol data from tcpdump.  By default, queries are grouped by fingerprint
and reported in descending order of query time (i.e. the slowest queries
first).  If no <code class="docutils literal notranslate"><span class="pre">FILES</span></code> are given, the tool reads <code class="docutils literal notranslate"><span class="pre">STDIN</span></code>.  The optional
<code class="docutils literal notranslate"><span class="pre">DSN</span></code> is used for certain options like <a class="reference internal" href="#cmdoption-mariadb-query-digest-since"><code class="xref std std-option docutils literal notranslate"><span class="pre">--since</span></code></a> and <a class="reference internal" href="#cmdoption-mariadb-query-digest-until"><code class="xref std std-option docutils literal notranslate"><span class="pre">--until</span></code></a>.</p>
<p>Report the slowest queries from <code class="docutils literal notranslate"><span class="pre">slow.log</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mariadb-query-digest slow.log
</pre></div>
</div>
<p>Report the slowest queries from the processlist on host1:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mariadb-query-digest --processlist <span class="nv">h</span><span class="o">=</span>host1
</pre></div>
</div>
<p>Capture MariaDB protocol data with tcppdump, then report the slowest queries:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tcpdump -s <span class="m">65535</span> -x -nn -q -tttt -i any -c <span class="m">1000</span> port <span class="m">3306</span> &gt; mariadb.tcp.txt

mariadb-query-digest --type tcpdump mariadb.tcp.txt
</pre></div>
</div>
<p>Save query data from <code class="docutils literal notranslate"><span class="pre">slow.log</span></code> to host2 for later review and trend analysis:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mariadb-query-digest --review <span class="nv">h</span><span class="o">=</span>host2 --no-report slow.log
</pre></div>
</div>
</div>
</div>
<div class="section" id="risks">
<h2>RISKS<a class="headerlink" href="#risks" title="Permalink to this headline">¶</a></h2>
<p>MariaDB Tools is mature, proven in the real world, and well tested,
but all database tools can pose a risk to the system and the database
server.  Before using this tool, please:</p>
<ul class="simple">
<li><p>Read the tool’s documentation</p></li>
<li><p>Review the tool’s known “BUGS”</p></li>
<li><p>Test the tool on a non-production server</p></li>
<li><p>Backup your production server and verify the backups</p></li>
</ul>
</div>
<div class="section" id="description">
<h2>DESCRIPTION<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p><strong class="program">mariadb-query-digest</strong> is a sophisticated but easy to use tool for analyzing
MariaDB queries.  It can analyze queries from MariaDB slow, general, and binary
logs. (Binary logs must first be converted to text, see <a class="reference internal" href="#cmdoption-mariadb-query-digest-type"><code class="xref std std-option docutils literal notranslate"><span class="pre">--type</span></code></a>).
It can also use <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROCESSLIST</span></code> and MariaDB protocol data from tcpdump.
By default, the tool reports which queries are the slowest, and therefore
the most important to optimize.  More complex and custom-tailored reports
can be created by using options like <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a>, <a class="reference internal" href="#cmdoption-mariadb-query-digest-filter"><code class="xref std std-option docutils literal notranslate"><span class="pre">--filter</span></code></a>, and
<a class="reference internal" href="#cmdoption-mariadb-query-digest-embedded-attributes"><code class="xref std std-option docutils literal notranslate"><span class="pre">--embedded-attributes</span></code></a>.</p>
<p>Query analysis is a best-practice that should be done frequently.  To
make this easier, <strong class="program">mariadb-query-digest</strong> has two features: query review
(<a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a>) and query history (<a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a>).  When the <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a>
option is used, all unique queries are saved to a database.  When the
tool is ran again with <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a>, queries marked as reviewed in
the database are not printed in the report.  This highlights new queries
that need to be reviewed.  When the <a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a> option is used,
query metrics (query time, lock time, etc.) for each unique query are
saved to database.  Each time the tool is ran with <a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a>, the
more historical data is saved which can be used to trend and analyze
query performance over time.</p>
</div>
<div class="section" id="attributes">
<h2>ATTRIBUTES<a class="headerlink" href="#attributes" title="Permalink to this headline">¶</a></h2>
<p><strong class="program">mariadb-query-digest</strong> works on events, which are a collection of key-value pairs
called attributes.  You’ll recognize most of the attributes right away:
<code class="docutils literal notranslate"><span class="pre">Query_time</span></code>, <code class="docutils literal notranslate"><span class="pre">Lock_time</span></code>, and so on.  You can just look at a slow log
and see them.  However, there are some that don’t exist in the slow log,
and slow logs may actually include different kinds of attributes depending
upon the MariaDB Server version.</p>
<p>See “ATTRIBUTES REFERENCE” near the end of this documentation for a list
of common and <a class="reference internal" href="#cmdoption-mariadb-query-digest-type"><code class="xref std std-option docutils literal notranslate"><span class="pre">--type</span></code></a> specific attributes.  A familiarity with these
attributes is necessary for working with <a class="reference internal" href="#cmdoption-mariadb-query-digest-filter"><code class="xref std std-option docutils literal notranslate"><span class="pre">--filter</span></code></a>,
<a class="reference internal" href="#cmdoption-mariadb-query-digest-ignore-attributes"><code class="xref std std-option docutils literal notranslate"><span class="pre">--ignore-attributes</span></code></a>, and other attribute-related options.</p>
<p>With creative use of <a class="reference internal" href="#cmdoption-mariadb-query-digest-filter"><code class="xref std std-option docutils literal notranslate"><span class="pre">--filter</span></code></a>, you can create new attributes derived
from existing attributes.  For example, to create an attribute called
<code class="docutils literal notranslate"><span class="pre">Row_ratio</span></code> for examining the ratio of <code class="docutils literal notranslate"><span class="pre">Rows_sent</span></code> to <code class="docutils literal notranslate"><span class="pre">Rows_examined</span></code>,
specify a filter like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--filter <span class="s1">&#39;($event-&gt;{Row_ratio} = $event-&gt;{Rows_sent} / ($event-&gt;{Rows_examined})) &amp;&amp; 1&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span> <span class="pre">1</span></code> trick is needed to create a valid one-line syntax that is always
true, even if the assignment happens to evaluate false.  The new attribute will
automatically appears in the output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Row ratio        1.00    0.00      1    0.50      1    0.71    0.50</span>
</pre></div>
</div>
<p>Attributes created this way can be specified for <a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a> or any
option that requires an attribute.</p>
</div>
<div class="section" id="output">
<h2>OUTPUT<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h2>
<p>The default <a class="reference internal" href="#cmdoption-mariadb-query-digest-output"><code class="xref std std-option docutils literal notranslate"><span class="pre">--output</span></code></a> is a query analysis report.  The <a class="reference internal" href="#cmdoption-mariadb-query-digest-no-report"><code class="xref std std-option docutils literal notranslate"><span class="pre">--[no]report</span></code></a>
option controls whether or not this report is printed.  Sometimes you may
want to parse all the queries but suppress the report, for example when using
<a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a> or <a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a>.</p>
<p>There is one paragraph for each class of query analyzed.  A “class” of queries
all have the same value for the <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> attribute which is
<code class="docutils literal notranslate"><span class="pre">fingerprint</span></code> by default.  (See “ATTRIBUTES”.)  A fingerprint is an
abstracted version of the query text with literals removed, whitespace
collapsed, and so forth.  The report is formatted so it’s easy to paste into
emails without wrapping, and all non-query lines begin with a comment, so you
can save it to a .sql file and open it in your favorite syntax-highlighting
text editor.  There is a response-time profile at the beginning.</p>
<p>The output described here is controlled by <a class="reference internal" href="#cmdoption-mariadb-query-digest-report-format"><code class="xref std std-option docutils literal notranslate"><span class="pre">--report-format</span></code></a>.
That option allows you to specify what to print and in what order.
The default output in the default order is described here.</p>
<p>The report, by default, begins with a paragraph about the entire analysis run
The information is very similar to what you’ll see for each class of queries in
the log, but it doesn’t have some information that would be too expensive to
keep globally for the analysis.  It also has some statistics about the code’s
execution itself, such as the CPU and memory usage, the local date and time
of the run, and a list of input file read/parsed.</p>
<p>Following this is the response-time profile over the events.  This is a
highly summarized view of the unique events in the detailed query report
that follows.  It contains the following columns:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Column        <span class="nv">Meaning</span>
<span class="o">============</span>  <span class="o">==========================================================</span>
Rank          The query<span class="s1">&#39;s rank within the entire set of queries analyzed</span>
<span class="s1">Query ID      The query&#39;</span>s fingerprint
Response <span class="nb">time</span> The total response time, and percentage of overall total
Calls         The number of <span class="nb">times</span> this query was executed
R/Call        The mean response <span class="nb">time</span> per execution
V/M           The Variance-to-mean ratio of response <span class="nb">time</span>
Item          The distilled query
</pre></div>
</div>
<p>A final line whose rank is shown as MISC contains aggregate statistics on the
queries that were not included in the report, due to options such as
<a class="reference internal" href="#cmdoption-mariadb-query-digest-limit"><code class="xref std std-option docutils literal notranslate"><span class="pre">--limit</span></code></a> and <a class="reference internal" href="#cmdoption-mariadb-query-digest-outliers"><code class="xref std std-option docutils literal notranslate"><span class="pre">--outliers</span></code></a>.  For details on the variance-to-mean ratio,
please see <a class="reference external" href="http://en.wikipedia.org/wiki/Index_of_dispersion">http://en.wikipedia.org/wiki/Index_of_dispersion</a>.</p>
<p>Next, the detailed query report is printed.  Each query appears in a paragraph.
Here is a sample, slightly reformatted so ‘perldoc’ will not wrap lines in a
terminal.  The following will all be one paragraph, but we’ll break it up for
commentary.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Query 2: 0.01 QPS, 0.02x conc, ID 0xFDEA8D2993C9CAF3 at byte 160665</span>
</pre></div>
</div>
<p>This line identifies the sequential number of the query in the sort order
specified by <a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a>.  Then there’s the queries per second, and the
approximate concurrency for this query (calculated as a function of the timespan
and total Query_time).  Next there’s a query ID.  This ID is a hex version of
the query’s checksum in the database, if you’re using <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a>.  You can
select the reviewed query’s details from the database with a query like <code class="docutils literal notranslate"><span class="pre">SELECT</span>
<span class="pre">....</span> <span class="pre">WHERE</span> <span class="pre">checksum=0xFDEA8D2993C9CAF3</span></code>.</p>
<p>If you are investigating the report and want to print out every sample of a
particular query, then the following <a class="reference internal" href="#cmdoption-mariadb-query-digest-filter"><code class="xref std std-option docutils literal notranslate"><span class="pre">--filter</span></code></a> may be helpful:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mariadb-query-digest slow.log           <span class="se">\</span>
   --no-report                     <span class="se">\</span>
   --output slowlog                <span class="se">\</span>
   --filter <span class="s1">&#39;$event-&gt;{fingerprint} \</span>
<span class="s1">        &amp;&amp; make_checksum($event-&gt;{fingerprint}) eq &quot;FDEA8D2993C9CAF3&quot;&#39;</span>
</pre></div>
</div>
<p>Notice that you must remove the <code class="docutils literal notranslate"><span class="pre">0x</span></code> prefix from the checksum.</p>
<p>Finally, in case you want to find a sample of the query in the log file, there’s
the byte offset where you can look.  (This is not always accurate, due to some
anomalies in the slow log format, but it’s usually right.)  The position
refers to the worst sample, which we’ll see more about below.</p>
<p>Next is the table of metrics about this class of queries.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#           pct   total    min    max     avg     95%  stddev  median</span>
<span class="c1"># Count       0       2</span>
<span class="c1"># Exec time  13   1105s   552s   554s    553s    554s      2s    553s</span>
<span class="c1"># Lock time   0   216us   99us  117us   108us   117us    12us   108us</span>
<span class="c1"># Rows sent  20   6.26M  3.13M  3.13M   3.13M   3.13M   12.73   3.13M</span>
<span class="c1"># Rows exam   0   6.26M  3.13M  3.13M   3.13M   3.13M   12.73   3.13M</span>
</pre></div>
</div>
<p>The first line is column headers for the table.  The percentage is the percent
of the total for the whole analysis run, and the total is the actual value of
the specified metric.  For example, in this case we can see that the query
executed 2 times, which is 13% of the total number of queries in the file.  The
min, max and avg columns are self-explanatory.  The 95% column shows the 95th
percentile; 95% of the values are less than or equal to this value.  The
standard deviation shows you how tightly grouped the values are.  The standard
deviation and median are both calculated from the 95th percentile, discarding
the extremely large values.</p>
<p>The stddev, median and 95th percentile statistics are approximate.  Exact
statistics require keeping every value seen, sorting, and doing some
calculations on them.  This uses a lot of memory.  To avoid this, we keep 1000
buckets, each of them 5% bigger than the one before, ranging from .000001 up to
a very big number.  When we see a value we increment the bucket into which it
falls.  Thus we have fixed memory per class of queries.  The drawback is the
imprecision, which typically falls in the 5 percent range.</p>
<p>Next we have statistics on the users, databases and time range for the query.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Users       1   user1</span>
<span class="c1"># Databases   2     db1(1), db2(1)</span>
<span class="c1"># Time range 2008-11-26 04:55:18 to 2008-11-27 00:15:15</span>
</pre></div>
</div>
<p>The users and databases are shown as a count of distinct values, followed by the
values.  If there’s only one, it’s shown alone; if there are many, we show each
of the most frequent ones, followed by the number of times it appears.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Query_time distribution</span>
<span class="c1">#   1us</span>
<span class="c1">#  10us</span>
<span class="c1"># 100us</span>
<span class="c1">#   1ms</span>
<span class="c1">#  10ms  #####</span>
<span class="c1"># 100ms  ####################</span>
<span class="c1">#    1s  ##########</span>
<span class="c1">#  10s+</span>
</pre></div>
</div>
<p>The execution times show a logarithmic chart of time clustering.  Each query
goes into one of the “buckets” and is counted up.  The buckets are powers of
ten.  The first bucket is all values in the “single microsecond range” – that
is, less than 10us.  The second is “tens of microseconds,” which is from 10us
up to (but not including) 100us; and so on.  The charted attribute can be
changed by specifying <a class="reference internal" href="#cmdoption-mariadb-query-digest-report-histogram"><code class="xref std std-option docutils literal notranslate"><span class="pre">--report-histogram</span></code></a> but is limited to time-based
attributes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tables</span>
<span class="c1">#    SHOW TABLE STATUS LIKE &#39;table1&#39;\G</span>
<span class="c1">#    SHOW CREATE TABLE `table1`\G</span>
<span class="c1"># EXPLAIN</span>
SELECT * FROM table1<span class="se">\G</span>
</pre></div>
</div>
<p>This section is a convenience: if you’re trying to optimize the queries you see
in the slow log, you probably want to examine the table structure and size.
These are copy-and-paste-ready commands to do that.</p>
<p>Finally, we see a sample of the queries in this class of query.  This is not a
random sample.  It is the query that performed the worst, according to the sort
order given by <a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a>.  You will normally see a commented <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">EXPLAIN</span></code>
line just before it, so you can copy-paste the query to examine its EXPLAIN
plan. But for non-SELECT queries that isn’t possible to do, so the tool tries to
transform the query into a roughly equivalent SELECT query, and adds that below.</p>
<p>If you want to find this sample event in the log, use the offset mentioned
above, and something like the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tail -c +&lt;offset&gt; /path/to/file <span class="p">|</span> head
</pre></div>
</div>
<p>See also <a class="reference internal" href="#cmdoption-mariadb-query-digest-report-format"><code class="xref std std-option docutils literal notranslate"><span class="pre">--report-format</span></code></a>.</p>
</div>
<div class="section" id="query-review">
<h2>QUERY REVIEW<a class="headerlink" href="#query-review" title="Permalink to this headline">¶</a></h2>
<p>A query <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a> is the process of storing all the query fingerprints
analyzed.  This has several benefits:</p>
<ul class="simple">
<li><p>You can add metadata to classes of queries, such as marking them for follow-up,
adding notes to queries, or marking them with an issue ID for your issue
tracking system.</p></li>
<li><p>You can refer to the stored values on subsequent runs so you’ll know whether
you’ve seen a query before.  This can help you cut down on duplicated work.</p></li>
<li><p>You can store historical data such as the row count, query times, and generally
anything you can see in the report.</p></li>
</ul>
<p>To use this feature, you run <strong class="program">mariadb-query-digest</strong> with the <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a> option.  It
will store the fingerprints and other information into the table you specify.
Next time you run it with the same option, it will do the following:</p>
<ul>
<li><p>It won’t show you queries you’ve already reviewed.  A query is considered to be
already reviewed if you’ve set a value for the <code class="docutils literal notranslate"><span class="pre">reviewed_by</span></code> column.  (If you
want to see queries you’ve already reviewed, use the <a class="reference internal" href="#cmdoption-mariadb-query-digest-report-all"><code class="xref std std-option docutils literal notranslate"><span class="pre">--report-all</span></code></a> option.)</p></li>
<li><p>Queries that you’ve reviewed, and don’t appear in the output, will cause gaps in
the query number sequence in the first line of each paragraph.  And the value
you’ve specified for <a class="reference internal" href="#cmdoption-mariadb-query-digest-limit"><code class="xref std std-option docutils literal notranslate"><span class="pre">--limit</span></code></a> will still be honored.  So if you’ve reviewed all
queries in the top 10 and you ask for the top 10, you won’t see anything in the
output.</p></li>
<li><p>If you want to see the queries you’ve already reviewed, you can specify
<a class="reference internal" href="#cmdoption-mariadb-query-digest-report-all"><code class="xref std std-option docutils literal notranslate"><span class="pre">--report-all</span></code></a>.  Then you’ll see the normal analysis output, but you’ll
also see the information from the review table, just below the execution time
graph.  For example,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Review information</span>
<span class="c1">#      comments: really bad IN() subquery, fix soon!</span>
<span class="c1">#    first_seen: 2008-12-01 11:48:57</span>
<span class="c1">#   jira_ticket: 1933</span>
<span class="c1">#     last_seen: 2008-12-18 11:49:07</span>
<span class="c1">#      priority: high</span>
<span class="c1">#   reviewed_by: xaprb</span>
<span class="c1">#   reviewed_on: 2008-12-18 15:03:11</span>
</pre></div>
</div>
<p>This metadata is useful because, as you analyze your queries, you get
your comments integrated right into the report.</p>
</li>
</ul>
</div>
<div class="section" id="fingerprints">
<h2>FINGERPRINTS<a class="headerlink" href="#fingerprints" title="Permalink to this headline">¶</a></h2>
<p>A query fingerprint is the abstracted form of a query, which makes it possible
to group similar queries together.  Abstracting a query removes literal values,
normalizes whitespace, and so on.  For example, consider these two queries:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>SELECT name, password FROM user WHERE <span class="nv">id</span><span class="o">=</span><span class="s1">&#39;12823&#39;</span><span class="p">;</span>
<span class="k">select</span> name,   password from user
   where <span class="nv">id</span><span class="o">=</span><span class="m">5</span><span class="p">;</span>
</pre></div>
</div>
<p>Both of those queries will fingerprint to</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> name, password from user where <span class="nv">id</span><span class="o">=</span>?
</pre></div>
</div>
<p>Once the query’s fingerprint is known, we can then talk about a query as though
it represents all similar queries.</p>
<p>What <strong class="program">mariadb-query-digest</strong> does is analogous to a GROUP BY statement in SQL.  (But
note that “multiple columns” doesn’t define a multi-column grouping; it defines
multiple reports!) If your command-line looks like this,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mariadb-query-digest               <span class="se">\</span>
    --group-by fingerprint    <span class="se">\</span>
    --order-by Query_time:sum <span class="se">\</span>
    --limit <span class="m">10</span>                <span class="se">\</span>
    slow.log
</pre></div>
</div>
<p>The corresponding pseudo-SQL looks like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>SELECT WORST<span class="o">(</span>query BY Query_time<span class="o">)</span>, SUM<span class="o">(</span>Query_time<span class="o">)</span>, ...
FROM /path/to/slow.log
GROUP BY FINGERPRINT<span class="o">(</span>query<span class="o">)</span>
ORDER BY SUM<span class="o">(</span>Query_time<span class="o">)</span> DESC
LIMIT <span class="m">10</span>
</pre></div>
</div>
<p>You can also use the value <code class="docutils literal notranslate"><span class="pre">distill</span></code>, which is a kind of super-fingerprint.
See <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> for more.</p>
<p>Query fingerprinting accommodates many special cases, which have proven
necessary in the real world.  For example, an <code class="docutils literal notranslate"><span class="pre">IN</span></code> list with 5 literals
is really equivalent to one with 4 literals, so lists of literals are
collapsed to a single one.  If you find something that is not fingerprinted
properly, please submit a bug report with a reproducible test case.</p>
<p>Here is a list of transformations during fingerprinting, which might not
be exhaustive:</p>
<ul class="simple">
<li><p>Group all SELECT queries from mariadb-dump together, even if they are against
different tables.  The same applies to all queries from pt-table-checksum.</p></li>
<li><p>Shorten multi-value INSERT statements to a single VALUES() list.</p></li>
<li><p>Strip comments.</p></li>
<li><p>Abstract the databases in USE statements, so all USE statements are grouped
together.</p></li>
<li><p>Replace all literals, such as quoted strings.  For efficiency, the code that
replaces literal numbers is somewhat non-selective, and might replace some
things as numbers when they really are not.  Hexadecimal literals are also
replaced.  NULL is treated as a literal.  Numbers embedded in identifiers are
also replaced, so tables named similarly will be fingerprinted to the same
values (e.g. users_2009 and users_2010 will fingerprint identically).</p></li>
<li><p>Collapse all whitespace into a single space.</p></li>
<li><p>Lowercase the entire query.</p></li>
<li><p>Replace all literals inside of IN() and VALUES() lists with a single
placeholder, regardless of cardinality.</p></li>
<li><p>Collapse multiple identical UNION queries into a single one.</p></li>
</ul>
</div>
<div class="section" id="options">
<h2>OPTIONS<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h2>
<p>This tool accepts additional command-line arguments.  Refer to the
“SYNOPSIS” and usage information for details.</p>
<dl class="option">
<dt id="cmdoption-mariadb-query-digest-ask-pass">
<code class="sig-name descname">--ask-pass</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-ask-pass" title="Permalink to this definition">¶</a></dt>
<dd><p>Prompt for a password when connecting to MariaDB.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-attribute-aliases">
<code class="sig-name descname">--attribute-aliases</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-attribute-aliases" title="Permalink to this definition">¶</a></dt>
<dd><p>type: array; default: db|Schema</p>
<p>List of attribute|alias,etc.</p>
<p>Certain attributes have multiple names, like db and Schema.  If an event does
not have the primary attribute, <strong class="program">mariadb-query-digest</strong> looks for an alias attribute.
If it finds an alias, it creates the primary attribute with the alias
attribute’s value and removes the alias attribute.</p>
<p>If the event has the primary attribute, all alias attributes are deleted.</p>
<p>This helps simplify event attributes so that, for example, there will not
be report lines for both db and Schema.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-attribute-value-limit">
<code class="sig-name descname">--attribute-value-limit</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-attribute-value-limit" title="Permalink to this definition">¶</a></dt>
<dd><p>type: int; default: 0</p>
<p>A sanity limit for attribute values.</p>
<p>This option deals with bugs in slow logging functionality that causes large
values for attributes.  If the attribute’s value is bigger than this, the
last-seen value for that class of query is used instead.
Disabled by default.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-charset">
<code class="sig-name descname">--charset</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-charset" title="Permalink to this definition">¶</a></dt>
<dd><p>short form: -A; type: string</p>
<p>Default character set.  If the value is utf8, sets Perl’s binmode on
STDOUT to utf8, passes the mysql_enable_utf8 option to DBD::mysql, and
runs SET NAMES UTF8 after connecting to MariaDB.  Any other value sets
binmode on STDOUT without the utf8 layer, and runs SET NAMES after
connecting to MariaDB.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-config">
<code class="sig-name descname">--config</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-config" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Array</p>
<p>Read this comma-separated list of config files; if specified, this must be the
first option on the command line.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-no-continue-on-error">
<code class="sig-name descname">--[no]continue-on-error</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-no-continue-on-error" title="Permalink to this definition">¶</a></dt>
<dd><p>default: yes</p>
<p>Continue parsing even if there is an error.  The tool will not continue
forever: it stops once any process causes 100 errors, in which case there
is probably a bug in the tool or the input is invalid.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-no-create-history-table">
<code class="sig-name descname">--[no]create-history-table</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-no-create-history-table" title="Permalink to this definition">¶</a></dt>
<dd><p>default: yes</p>
<p>Create the <a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a> table if it does not exist.</p>
<p>This option causes the table specified by <a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a> to be created
with the default structure shown in the documentation for <a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a>.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-no-create-review-table">
<code class="sig-name descname">--[no]create-review-table</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-no-create-review-table" title="Permalink to this definition">¶</a></dt>
<dd><p>default: yes</p>
<p>Create the <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a> table if it does not exist.</p>
<p>This option causes the table specified by <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a> to be created
with the default structure shown in the documentation for <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a>.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-daemonize">
<code class="sig-name descname">--daemonize</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-daemonize" title="Permalink to this definition">¶</a></dt>
<dd><p>Fork to the background and detach from the shell.  POSIX
operating systems only.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-database">
<code class="sig-name descname">--database</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-database" title="Permalink to this definition">¶</a></dt>
<dd><p>short form: -D; type: string</p>
<p>Connect to this database.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-defaults-file">
<code class="sig-name descname">--defaults-file</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-defaults-file" title="Permalink to this definition">¶</a></dt>
<dd><p>short form: -F; type: string</p>
<p>Only read mariadb options from the given file.  You must give an absolute pathname.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-embedded-attributes">
<code class="sig-name descname">--embedded-attributes</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-embedded-attributes" title="Permalink to this definition">¶</a></dt>
<dd><p>type: array</p>
<p>Two Perl regex patterns to capture pseudo-attributes embedded in queries.</p>
<p>Embedded attributes might be special attribute-value pairs that you’ve hidden
in comments.  The first regex should match the entire set of attributes (in
case there are multiple).  The second regex should match and capture
attribute-value pairs from the first regex.</p>
<p>For example, suppose your query looks like the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>SELECT * from users -- file: /login.php, line: <span class="m">493</span><span class="p">;</span>
</pre></div>
</div>
<p>You might run <strong class="program">mariadb-query-digest</strong> with the following option:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>:program:<span class="sb">`</span>mariadb-query-digest<span class="sb">`</span> --embedded-attributes <span class="s1">&#39; -- .*&#39;</span>,<span class="s1">&#39;(\w+): ([^\,]+)&#39;</span>
</pre></div>
</div>
<p>The first regular expression captures the whole comment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot; -- file: /login.php, line: 493;&quot;</span>
</pre></div>
</div>
<p>The second one splits it into attribute-value pairs and adds them to the event:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ATTRIBUTE  <span class="nv">VALUE</span>
<span class="o">=========</span>  <span class="o">==========</span>
file       /login.php
line       <span class="m">493</span>
</pre></div>
</div>
<p><strong>NOTE</strong>: All commas in the regex patterns must be escaped with otherwise
the pattern will break.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-expected-range">
<code class="sig-name descname">--expected-range</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-expected-range" title="Permalink to this definition">¶</a></dt>
<dd><p>type: array; default: 5,10</p>
<p>Explain items when there are more or fewer than expected.</p>
<p>Defines the number of items expected to be seen in the report given by
<a class="reference internal" href="#cmdoption-mariadb-query-digest-no-report"><code class="xref std std-option docutils literal notranslate"><span class="pre">--[no]report</span></code></a>, as controlled by <a class="reference internal" href="#cmdoption-mariadb-query-digest-limit"><code class="xref std std-option docutils literal notranslate"><span class="pre">--limit</span></code></a> and <a class="reference internal" href="#cmdoption-mariadb-query-digest-outliers"><code class="xref std std-option docutils literal notranslate"><span class="pre">--outliers</span></code></a>.  If
there  are more or fewer items in the report, each one will explain why it was
included.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-explain">
<code class="sig-name descname">--explain</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-explain" title="Permalink to this definition">¶</a></dt>
<dd><p>type: DSN</p>
<p>Run EXPLAIN for the sample query with this DSN and print results.</p>
<p>This works only when <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> includes fingerprint.  It causes
<strong class="program">mariadb-query-digest</strong> to run EXPLAIN and include the output into the report.  For
safety, queries that appear to have a subquery that EXPLAIN will execute won’t
be EXPLAINed.  Those are typically “derived table” queries of the form</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> ... from <span class="o">(</span> <span class="k">select</span> .... <span class="o">)</span> der<span class="p">;</span>
</pre></div>
</div>
<p>The EXPLAIN results are printed as a full vertical format in the event report,
which appears at the end of each event report in vertical style
(<code class="docutils literal notranslate"><span class="pre">\G</span></code>) just like MariaDB prints it.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-filter">
<code class="sig-name descname">--filter</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-filter" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>Discard events for which this Perl code doesn’t return true.</p>
<p>This option is a string of Perl code or a file containing Perl code that gets
compiled into a subroutine with one argument: $event.  This is a hashref.
If the given value is a readable file, then <strong class="program">mariadb-query-digest</strong> reads the entire
file and uses its contents as the code.  The file should not contain
a shebang (#!/usr/bin/perl) line.</p>
<p>If the code returns true, the chain of callbacks continues; otherwise it ends.
The code is the last statement in the subroutine other than <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">$event</span></code>.
The subroutine template is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sub <span class="o">{</span> <span class="nv">$event</span> <span class="o">=</span> shift<span class="p">;</span> filter <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="nv">$event</span><span class="p">;</span> <span class="o">}</span>
</pre></div>
</div>
<p>Filters given on the command line are wrapped inside parentheses like like
<code class="docutils literal notranslate"><span class="pre">(</span> <span class="pre">filter</span> <span class="pre">)</span></code>.  For complex, multi-line filters, you must put the code inside
a file so it will not be wrapped inside parentheses.  Either way, the filter
must produce syntactically valid code given the template.  For example, an
if-else branch given on the command line would not be valid:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--filter <span class="s1">&#39;if () { } else { }&#39;</span>  <span class="c1"># WRONG</span>
</pre></div>
</div>
<p>Since it’s given on the command line, the if-else branch would be wrapped inside
parentheses which is not syntactically valid.  So to accomplish something more
complex like this would require putting the code in a file, for example
filter.txt:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>my <span class="nv">$event_ok</span><span class="p">;</span> <span class="k">if</span> <span class="o">(</span>...<span class="o">)</span> <span class="o">{</span> <span class="nv">$event_ok</span><span class="o">=</span><span class="m">1</span><span class="p">;</span> <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="nv">$event_ok</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> <span class="o">}</span> <span class="nv">$event_ok</span>
</pre></div>
</div>
<p>Then specify <code class="docutils literal notranslate"><span class="pre">--filter</span> <span class="pre">filter.txt</span></code> to read the code from filter.txt.</p>
<p>If the filter code won’t compile, <strong class="program">mariadb-query-digest</strong> will die with an error.
If the filter code does compile, an error may still occur at runtime if the
code tries to do something wrong (like pattern match an undefined value).
<strong class="program">mariadb-query-digest</strong> does not provide any safeguards so code carefully!</p>
<p>An example filter that discards everything but SELECT statements:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--filter <span class="s1">&#39;$event-&gt;{arg} =~ m/^select/i&#39;</span>
</pre></div>
</div>
<p>This is compiled into a subroutine like the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sub <span class="o">{</span> <span class="nv">$event</span> <span class="o">=</span> shift<span class="p">;</span> <span class="o">(</span> <span class="nv">$event</span>-&gt;<span class="o">{</span>arg<span class="o">}</span> <span class="o">=</span>~ m/^select/i <span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="nv">$event</span><span class="p">;</span> <span class="o">}</span>
</pre></div>
</div>
<p>It is permissible for the code to have side effects (to alter <code class="docutils literal notranslate"><span class="pre">$event</span></code>).</p>
<p>See “ATTRIBUTES REFERENCE” for a list of common and <a class="reference internal" href="#cmdoption-mariadb-query-digest-type"><code class="xref std std-option docutils literal notranslate"><span class="pre">--type</span></code></a> specific
attributes.</p>
<p>Here are more examples of filter code:</p>
<p>Host/IP matches domain.com</p>
<blockquote>
<div><p>–filter ‘($event-&gt;{host} || $event-&gt;{ip} || “”) =~ m/domain.com/’</p>
<p>Sometimes MariaDB logs the host where the IP is expected.  Therefore, we
check both.</p>
</div></blockquote>
<p>User matches john</p>
<blockquote>
<div><p>–filter ‘($event-&gt;{user} || “”) =~ m/john/’</p>
</div></blockquote>
<p>More than 1 warning</p>
<blockquote>
<div><p>–filter ‘($event-&gt;{Warning_count} || 0) &gt; 1’</p>
</div></blockquote>
<p>Query does full table scan or full join</p>
<blockquote>
<div><p>–filter ‘(($event-&gt;{Full_scan} || “”) eq “Yes”) || (($event-&gt;{Full_join} || “”) eq “Yes”)’</p>
</div></blockquote>
<p>Query was not served from query cache</p>
<blockquote>
<div><p>–filter ‘($event-&gt;{QC_Hit} || “”) eq “No”’</p>
</div></blockquote>
<p>Query is 1 MB or larger</p>
<blockquote>
<div><p>–filter ‘$event-&gt;{bytes} &gt;= 1_048_576’</p>
</div></blockquote>
<p>Since <a class="reference internal" href="#cmdoption-mariadb-query-digest-filter"><code class="xref std std-option docutils literal notranslate"><span class="pre">--filter</span></code></a> allows you to alter <code class="docutils literal notranslate"><span class="pre">$event</span></code>, you can use it to do other
things, like create new attributes.  See “ATTRIBUTES” for an example.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-group-by">
<code class="sig-name descname">--group-by</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-group-by" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Array; default: fingerprint</p>
<p>Which attribute of the events to group by.</p>
<p>In general, you can group queries into classes based on any attribute of the
query, such as <code class="docutils literal notranslate"><span class="pre">user</span></code> or <code class="docutils literal notranslate"><span class="pre">db</span></code>, which will by default show you which users
and which databases get the most <code class="docutils literal notranslate"><span class="pre">Query_time</span></code>.  The default attribute,
<code class="docutils literal notranslate"><span class="pre">fingerprint</span></code>, groups similar, abstracted queries into classes; see below
and see also “FINGERPRINTS”.</p>
<p>A report is printed for each <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> value (unless <code class="docutils literal notranslate"><span class="pre">--no-report</span></code> is
given).  Therefore, <code class="docutils literal notranslate"><span class="pre">--group-by</span> <span class="pre">user,db</span></code> means “report on queries with the
same user and report on queries with the same db”; it does not mean “report
on queries with the same user and db.”  See also “OUTPUT”.</p>
<p>Every value must have a corresponding value in the same position in
<a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a>.  However, adding values to <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> will automatically
add values to <a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a>, for your convenience.</p>
<p>There are several magical values that cause some extra data mining to happen
before the grouping takes place:</p>
<p>fingerprint</p>
<blockquote>
<div><p>This causes events to be fingerprinted to abstract queries into
a canonical form, which is then used to group events together into a class.
See “FINGERPRINTS” for more about fingerprinting.</p>
</div></blockquote>
<p>tables</p>
<blockquote>
<div><p>This causes events to be inspected for what appear to be tables, and
then aggregated by that.  Note that a query that contains two or more tables
will be counted as many times as there are tables; so a join against two tables
will count the Query_time against both tables.</p>
</div></blockquote>
<p>distill</p>
<blockquote>
<div><p>This is a sort of super-fingerprint that collapses queries down
into a suggestion of what they do, such as <code class="docutils literal notranslate"><span class="pre">INSERT</span> <span class="pre">SELECT</span> <span class="pre">table1</span> <span class="pre">table2</span></code>.</p>
</div></blockquote>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-help">
<code class="sig-name descname">--help</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-help" title="Permalink to this definition">¶</a></dt>
<dd><p>Show help and exit.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-history">
<code class="sig-name descname">--history</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-history" title="Permalink to this definition">¶</a></dt>
<dd><p>type: DSN</p>
<p>Save metrics for each query class in the given table.  <strong class="program">mariadb-query-digest</strong> saves
query metrics (query time, lock time, etc.) to this table so you can see how
query classes change over time.</p>
<p>The default table is <code class="docutils literal notranslate"><span class="pre">mariadb_tools.query_history</span></code>.  Specify database
(D) and table (t) DSN options to override the default.  The database and
table are automatically created unless <code class="docutils literal notranslate"><span class="pre">--no-create-history-table</span></code>
is specified (see <a class="reference internal" href="#cmdoption-mariadb-query-digest-no-create-history-table"><code class="xref std std-option docutils literal notranslate"><span class="pre">--[no]create-history-table</span></code></a>).</p>
<p><strong class="program">mariadb-query-digest</strong> inspects the columns in the table.  The table must have at
least the following columns:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">query_review_history</span> <span class="p">(</span>
  <span class="n">checksum</span>     <span class="nb">CHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">sample</span>       <span class="n">LONGTEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Any columns not mentioned above are inspected to see if they follow a certain
naming convention.  The column is special if the name ends with an underscore
followed by any of these values:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pct<span class="p">|</span>avg<span class="p">|</span>cnt<span class="p">|</span>sum<span class="p">|</span>min<span class="p">|</span>max<span class="p">|</span>pct_95<span class="p">|</span>stddev<span class="p">|</span>median<span class="p">|</span>rank
</pre></div>
</div>
<p>If the column ends with one of those values, then the prefix is interpreted as
the event attribute to store in that column, and the suffix is interpreted as
the metric to be stored.  For example, a column named <code class="docutils literal notranslate"><span class="pre">Query_time_min</span></code> will be
used to store the minimum <code class="docutils literal notranslate"><span class="pre">Query_time</span></code> for the class of events.</p>
<p>The table should also have a primary key, but that is up to you, depending on
how you want to store the historical data.  We suggest adding ts_min and ts_max
columns and making them part of the primary key along with the checksum.  But
you could also just add a ts_min column and make it a DATE type, so you’d get
one row per class of queries per day.</p>
<p>The following table definition is used for <a class="reference internal" href="#cmdoption-mariadb-query-digest-no-create-history-table"><code class="xref std std-option docutils literal notranslate"><span class="pre">--[no]create-history-table</span></code></a>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">query_history</span> <span class="p">(</span>
  <span class="n">checksum</span>             <span class="nb">CHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">sample</span>               <span class="n">LONGTEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">ts_min</span>               <span class="n">DATETIME</span><span class="p">,</span>
  <span class="n">ts_max</span>               <span class="n">DATETIME</span><span class="p">,</span>
  <span class="n">ts_cnt</span>               <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Query_time_sum</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Query_time_min</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Query_time_max</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Query_time_pct_95</span>    <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Query_time_stddev</span>    <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Query_time_median</span>    <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Lock_time_sum</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Lock_time_min</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Lock_time_max</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Lock_time_pct_95</span>     <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Lock_time_stddev</span>     <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Lock_time_median</span>     <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_sent_sum</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_sent_min</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_sent_max</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_sent_pct_95</span>     <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_sent_stddev</span>     <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_sent_median</span>     <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_examined_sum</span>    <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_examined_min</span>    <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_examined_max</span>    <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_examined_pct_95</span> <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_examined_stddev</span> <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_examined_median</span> <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="c1">-- extended slowlog attributes</span>
  <span class="n">Rows_affected_sum</span>             <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_affected_min</span>             <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_affected_max</span>             <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_affected_pct_95</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_affected_stddev</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_affected_median</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_read_sum</span>                 <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_read_min</span>                 <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_read_max</span>                 <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_read_pct_95</span>              <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_read_stddev</span>              <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Rows_read_median</span>              <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Merge_passes_sum</span>              <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Merge_passes_min</span>              <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Merge_passes_max</span>              <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Merge_passes_pct_95</span>           <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Merge_passes_stddev</span>           <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Merge_passes_median</span>           <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_ops_min</span>           <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_ops_max</span>           <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_ops_pct_95</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_ops_stddev</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_ops_median</span>        <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_bytes_min</span>         <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_bytes_max</span>         <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_bytes_pct_95</span>      <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_bytes_stddev</span>      <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_bytes_median</span>      <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_wait_min</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_wait_max</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_wait_pct_95</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_wait_stddev</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_IO_r_wait_median</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_rec_lock_wait_min</span>      <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_rec_lock_wait_max</span>      <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_rec_lock_wait_pct_95</span>   <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_rec_lock_wait_stddev</span>   <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_rec_lock_wait_median</span>   <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_queue_wait_min</span>         <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_queue_wait_max</span>         <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_queue_wait_pct_95</span>      <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_queue_wait_stddev</span>      <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_queue_wait_median</span>      <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_pages_distinct_min</span>     <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_pages_distinct_max</span>     <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_pages_distinct_pct_95</span>  <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_pages_distinct_stddev</span>  <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">InnoDB_pages_distinct_median</span>  <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="c1">-- Boolean (Yes/No) attributes.  Only the cnt and sum are needed</span>
  <span class="c1">-- for these.  cnt is how many times is attribute was recorded,</span>
  <span class="c1">-- and sum is how many of those times the value was Yes.  So</span>
  <span class="c1">-- sum/cnt * 100 equals the percentage of recorded times that</span>
  <span class="c1">-- the value was Yes.</span>
  <span class="n">QC_Hit_cnt</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">QC_Hit_sum</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Full_scan_cnt</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Full_scan_sum</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Full_join_cnt</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Full_join_sum</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Tmp_table_cnt</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Tmp_table_sum</span>       <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Tmp_table_on_disk_cnt</span> <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Tmp_table_on_disk_sum</span> <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Filesort_cnt</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Filesort_sum</span>          <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Filesort_on_disk_cnt</span>  <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">Filesort_on_disk_sum</span>  <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">checksum</span><span class="p">,</span> <span class="n">ts_min</span><span class="p">,</span> <span class="n">ts_max</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Note that we store the count (cnt) for the ts attribute only; it will be
redundant to store this for other attributes.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-host">
<code class="sig-name descname">--host</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-host" title="Permalink to this definition">¶</a></dt>
<dd><p>short form: -h; type: string</p>
<p>Connect to host.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-ignore-attributes">
<code class="sig-name descname">--ignore-attributes</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-ignore-attributes" title="Permalink to this definition">¶</a></dt>
<dd><p>type: array; default: arg, cmd, insert_id, ip, port, Thread_id, timestamp, exptime, flags, key, res, val, server_id, offset, end_log_pos, Xid</p>
<p>Do not aggregate these attributes.  Some attributes are not query metrics
but metadata which doesn’t need to be (or can’t be) aggregated.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-inherit-attributes">
<code class="sig-name descname">--inherit-attributes</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-inherit-attributes" title="Permalink to this definition">¶</a></dt>
<dd><p>type: array; default: db,ts</p>
<p>If missing, inherit these attributes from the last event that had them.</p>
<p>This option sets which attributes are inherited or carried forward to events
which do not have them.  For example, if one event has the db attribute equal
to “foo”, but the next event doesn’t have the db attribute, then it inherits
“foo” for its db attribute.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-interval">
<code class="sig-name descname">--interval</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-interval" title="Permalink to this definition">¶</a></dt>
<dd><p>type: float; default: .1</p>
<p>How frequently to poll the processlist, in seconds.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-iterations">
<code class="sig-name descname">--iterations</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-iterations" title="Permalink to this definition">¶</a></dt>
<dd><p>type: int; default: 1</p>
<p>How many times to iterate through the collect-and-report cycle.  If 0, iterate
to infinity.  Each iteration runs for <a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> amount of time.  An
iteration is usually determined by an amount of time and a report is printed
when that amount of time elapses.  With <a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time-mode"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time-mode</span></code></a> <code class="docutils literal notranslate"><span class="pre">interval</span></code>,
an interval is instead determined by the interval time you specify with
<a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a>.  See <a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> and <a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time-mode"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time-mode</span></code></a> for more
information.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-limit">
<code class="sig-name descname">--limit</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-limit" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Array; default: 95%:20</p>
<p>Limit output to the given percentage or count.</p>
<p>If the argument is an integer, report only the top N worst queries.  If the
argument is an integer followed by the <code class="docutils literal notranslate"><span class="pre">%</span></code> sign, report that percentage of the
worst queries.  If the percentage is followed by a colon and another integer,
report the top percentage or the number specified by that integer, whichever
comes first.</p>
<p>The value is actually a comma-separated array of values, one for each item in
<a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a>.  If you don’t specify a value for any of those items, the
default is the top 95%.</p>
<p>See also <a class="reference internal" href="#cmdoption-mariadb-query-digest-outliers"><code class="xref std std-option docutils literal notranslate"><span class="pre">--outliers</span></code></a>.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-log">
<code class="sig-name descname">--log</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-log" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>Print all output to this file when daemonized.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-max-hostname-length">
<code class="sig-name descname">--max-hostname-length</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-max-hostname-length" title="Permalink to this definition">¶</a></dt>
<dd><p>type: int; default: 10</p>
<p>Trim host names in reports to this length. 0=Do not trim host names.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-max-line-length">
<code class="sig-name descname">--max-line-length</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-max-line-length" title="Permalink to this definition">¶</a></dt>
<dd><p>type: int; default: 74</p>
<p>Trim lines to this length. 0=Do not trim lines.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-order-by">
<code class="sig-name descname">--order-by</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-order-by" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Array; default: Query_time:sum</p>
<p>Sort events by this attribute and aggregate function.</p>
<p>This is a comma-separated list of order-by expressions, one for each
<a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> attribute.  The default <code class="docutils literal notranslate"><span class="pre">Query_time:sum</span></code> is used for
<a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> attributes without explicitly given <a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a> attributes
(that is, if you specify more <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> attributes than corresponding
<a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a> attributes).  The syntax is <code class="docutils literal notranslate"><span class="pre">attribute:aggregate</span></code>.  See
“ATTRIBUTES” for valid attributes.  Valid aggregates are:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Aggregate <span class="nv">Meaning</span>
<span class="o">=========</span> <span class="o">============================</span>
sum       Sum/total attribute value
min       Minimum attribute value
max       Maximum attribute value
cnt       Frequency/count of the query
</pre></div>
</div>
<p>For example, the default <code class="docutils literal notranslate"><span class="pre">Query_time:sum</span></code> means that queries in the
query analysis report will be ordered (sorted) by their total query execution
time (“Exec time”).  <code class="docutils literal notranslate"><span class="pre">Query_time:max</span></code> orders the queries by their
maximum query execution time, so the query with the single largest
<code class="docutils literal notranslate"><span class="pre">Query_time</span></code> will be list first.  <code class="docutils literal notranslate"><span class="pre">cnt</span></code> refers more to the frequency
of the query as a whole, how often it appears; “Count” is its corresponding
line in the query analysis report.  So any attribute and <code class="docutils literal notranslate"><span class="pre">cnt</span></code> should yield
the same report wherein queries are sorted by the number of times they
appear.</p>
<p>When parsing general logs (<a class="reference internal" href="#cmdoption-mariadb-query-digest-type"><code class="xref std std-option docutils literal notranslate"><span class="pre">--type</span></code></a> <code class="docutils literal notranslate"><span class="pre">genlog</span></code>), the default <a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a>
becomes <code class="docutils literal notranslate"><span class="pre">Query_time:cnt</span></code>.  General logs do not report query times so only
the <code class="docutils literal notranslate"><span class="pre">cnt</span></code> aggregate makes sense because all query times are zero.</p>
<p>If you specify an attribute that doesn’t exist in the events, then
<strong class="program">mariadb-query-digest</strong> falls back to the default <code class="docutils literal notranslate"><span class="pre">Query_time:sum</span></code> and prints a notice
at the beginning of the report for each query class.  You can create attributes
with <a class="reference internal" href="#cmdoption-mariadb-query-digest-filter"><code class="xref std std-option docutils literal notranslate"><span class="pre">--filter</span></code></a> and order by them; see “ATTRIBUTES” for an example.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-outliers">
<code class="sig-name descname">--outliers</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-outliers" title="Permalink to this definition">¶</a></dt>
<dd><p>type: array; default: Query_time:1:10</p>
<p>Report outliers by attribute:percentile:count.</p>
<p>The syntax of this option is a comma-separated list of colon-delimited strings.
The first field is the attribute by which an outlier is defined.  The second is
a number that is compared to the attribute’s 95th percentile.  The third is
optional, and is compared to the attribute’s cnt aggregate.  Queries that pass
this specification are added to the report, regardless of any limits you
specified in <a class="reference internal" href="#cmdoption-mariadb-query-digest-limit"><code class="xref std std-option docutils literal notranslate"><span class="pre">--limit</span></code></a>.</p>
<p>For example, to report queries whose 95th percentile Query_time is at least 60
seconds and which are seen at least 5 times, use the following argument:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--outliers Query_time:60:5
</pre></div>
</div>
<p>You can specify an –outliers option for each value in <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a>.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-output">
<code class="sig-name descname">--output</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-output" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string; default: report</p>
<p>How to format and print the query analysis results.  Accepted values are:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>VALUE          <span class="nv">FORMAT</span>
<span class="o">=======</span>        <span class="o">==============================</span>
report         Standard query analysis report
slowlog        MariaDB slow log
json           JSON, on array per query class
json-anon      JSON without example queries
secure-slowlog JSON without example queries
</pre></div>
</div>
<p>The entire <code class="docutils literal notranslate"><span class="pre">report</span></code> output can be disabled by specifying <code class="docutils literal notranslate"><span class="pre">--no-report</span></code>
(see <a class="reference internal" href="#cmdoption-mariadb-query-digest-no-report"><code class="xref std std-option docutils literal notranslate"><span class="pre">--[no]report</span></code></a>), and its sections can be disabled or rearranged
by specifying <a class="reference internal" href="#cmdoption-mariadb-query-digest-report-format"><code class="xref std std-option docutils literal notranslate"><span class="pre">--report-format</span></code></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">json</span></code> output was introduced in 2.2.1 and is still in development,
so the data structure may change in future versions.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-password">
<code class="sig-name descname">--password</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-password" title="Permalink to this definition">¶</a></dt>
<dd><p>short form: -p; type: string</p>
<p>Password to use when connecting.
If password contains commas they must be escaped with a backslash: “exam,ple”</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-pid">
<code class="sig-name descname">--pid</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-pid" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>Create the given PID file.  The tool won’t start if the PID file already
exists and the PID it contains is different than the current PID.  However,
if the PID file exists and the PID it contains is no longer running, the
tool will overwrite the PID file with the current PID.  The PID file is
removed automatically when the tool exits.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-port">
<code class="sig-name descname">--port</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-port" title="Permalink to this definition">¶</a></dt>
<dd><p>short form: -P; type: int</p>
<p>Port number to use for connection.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-preserve-embedded-numbers">
<code class="sig-name descname">--preserve-embedded-numbers</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-preserve-embedded-numbers" title="Permalink to this definition">¶</a></dt>
<dd><p>Preserve numbers in database/table names when fingerprinting queries.
The standar fingeprint method replaces numbers in db/tables names, making
a query like ‘SELECT * FROM db1.table2’ to be figerprinted as ‘SELECT * FROM db?.table?’.
This option changes that behaviour and the fingerprint will become
‘SELECT * FROM db1.table2’.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-processlist">
<code class="sig-name descname">--processlist</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-processlist" title="Permalink to this definition">¶</a></dt>
<dd><p>type: DSN</p>
<p>Poll this DSN’s processlist for queries, with <a class="reference internal" href="#cmdoption-mariadb-query-digest-interval"><code class="xref std std-option docutils literal notranslate"><span class="pre">--interval</span></code></a> sleep between.</p>
<p>If the connection fails, <strong class="program">mariadb-query-digest</strong> tries to reopen it once per second.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-progress">
<code class="sig-name descname">--progress</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-progress" title="Permalink to this definition">¶</a></dt>
<dd><p>type: array; default: time,30</p>
<p>Print progress reports to STDERR.  The value is a comma-separated list with two
parts.  The first part can be percentage, time, or iterations; the second part
specifies how often an update should be printed, in percentage, seconds, or
number of iterations.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-read-timeout">
<code class="sig-name descname">--read-timeout</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-read-timeout" title="Permalink to this definition">¶</a></dt>
<dd><p>type: time; default: 0</p>
<p>Wait this long for an event from the input; 0 to wait forever.</p>
<p>This option sets the maximum time to wait for an event from the input.  It
applies to all types of input except <a class="reference internal" href="#cmdoption-mariadb-query-digest-processlist"><code class="xref std std-option docutils literal notranslate"><span class="pre">--processlist</span></code></a>.  If an
event is not received after the specified time, the script stops reading the
input and prints its reports.  If <a class="reference internal" href="#cmdoption-mariadb-query-digest-iterations"><code class="xref std std-option docutils literal notranslate"><span class="pre">--iterations</span></code></a> is 0 or greater than
1, the next iteration will begin, else the script will exit.</p>
<p>This option requires the Perl POSIX module.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-no-report">
<code class="sig-name descname">--[no]report</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-no-report" title="Permalink to this definition">¶</a></dt>
<dd><p>default: yes</p>
<p>Print query analysis reports for each <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a> attribute.  This is
the standard slow log analysis functionality.  See “OUTPUT” for the
description of what this does and what the results look like.</p>
<p>If you don’t need a report (for example, when using <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a> or
<a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a>), it is best to specify <code class="docutils literal notranslate"><span class="pre">--no-report</span></code> because this allows
the tool to skip some expensive operations.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-report-all">
<code class="sig-name descname">--report-all</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-report-all" title="Permalink to this definition">¶</a></dt>
<dd><p>Report all queries, even ones that have been reviewed.  This only affects
the <code class="docutils literal notranslate"><span class="pre">report</span></code> <a class="reference internal" href="#cmdoption-mariadb-query-digest-output"><code class="xref std std-option docutils literal notranslate"><span class="pre">--output</span></code></a> when using <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a>.  Otherwise, all
queries are always printed.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-report-format">
<code class="sig-name descname">--report-format</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-report-format" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Array; default: rusage,date,hostname,files,header,profile,query_report,prepared</p>
<p>Print these sections of the query analysis report.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>SECTION      <span class="nv">PRINTS</span>
<span class="o">============</span> <span class="o">======================================================</span>
rusage       CPU <span class="nb">times</span> and memory usage reported by ps
date         Current <span class="nb">local</span> date and <span class="nb">time</span>
hostname     Hostname of machine on which :program:<span class="sb">`</span>mariadb-query-digest<span class="sb">`</span> was run
files        Input files read/parse
header       Summary of the entire analysis run
profile      Compact table of queries <span class="k">for</span> an overview of the report
query_report Detailed information about each unique query
prepared     Prepared statements
</pre></div>
</div>
<p>The sections are printed in the order specified.  The rusage, date, files and
header sections are grouped together if specified together; other sections are
separated by blank lines.</p>
<p>See “OUTPUT” for more information on the various parts of the query report.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-report-histogram">
<code class="sig-name descname">--report-histogram</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-report-histogram" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string; default: Query_time</p>
<p>Chart the distribution of this attribute’s values.</p>
<p>The distribution chart is limited to time-based attributes, so charting
<code class="docutils literal notranslate"><span class="pre">Rows_examined</span></code>, for example, will produce a useless chart.  Charts look
like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Query_time distribution</span>
<span class="c1">#   1us</span>
<span class="c1">#  10us</span>
<span class="c1"># 100us</span>
<span class="c1">#   1ms</span>
<span class="c1">#  10ms  ###########################</span>
<span class="c1"># 100ms  ########################################################</span>
<span class="c1">#    1s  ########</span>
<span class="c1">#  10s+</span>
</pre></div>
</div>
<p>See “OUTPUT” for more information.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-resume">
<code class="sig-name descname">--resume</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-resume" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>If specified, the tool writes the last file offset, if there is one,
to the given filename. When ran again with the same value for this option,
the tool reads the last file offset from the file, seeks to that position
in the log, and resumes parsing events from that point onward.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-review">
<code class="sig-name descname">--review</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-review" title="Permalink to this definition">¶</a></dt>
<dd><p>type: DSN</p>
<p>Save query classes for later review, and don’t report already reviewed classes.</p>
<p>The default table is <code class="docutils literal notranslate"><span class="pre">mariadb_tools.query_review</span></code>.  Specify database
(D) and table (t) DSN options to override the default.  The database and
table are automatically created unless <code class="docutils literal notranslate"><span class="pre">--no-create-review-table</span></code>
is specified (see <a class="reference internal" href="#cmdoption-mariadb-query-digest-no-create-review-table"><code class="xref std std-option docutils literal notranslate"><span class="pre">--[no]create-review-table</span></code></a>).</p>
<p>If the table was created manually, it must have at least the following columns.
You can add more columns for your own special purposes, but they won’t be used
by <strong class="program">mariadb-query-digest</strong>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">query_review</span> <span class="p">(</span>
   <span class="n">checksum</span>     <span class="nb">CHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
   <span class="n">fingerprint</span>  <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
   <span class="n">sample</span>       <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
   <span class="n">first_seen</span>   <span class="n">DATETIME</span><span class="p">,</span>
   <span class="n">last_seen</span>    <span class="n">DATETIME</span><span class="p">,</span>
   <span class="n">reviewed_by</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
   <span class="n">reviewed_on</span>  <span class="n">DATETIME</span><span class="p">,</span>
   <span class="n">comments</span>     <span class="nb">TEXT</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The columns are:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>COLUMN       <span class="nv">MEANING</span>
<span class="o">===========</span>  <span class="o">====================================================</span>
checksum     A <span class="m">64</span>-bit checksum of the query fingerprint
fingerprint  The abstracted version of the query<span class="p">;</span> its primary key
sample       The query text of a sample of the class of queries
first_seen   The smallest timestamp of this class of queries
last_seen    The largest timestamp of this class of queries
reviewed_by  Initially NULL<span class="p">;</span> <span class="k">if</span> set, query is skipped thereafter
reviewed_on  Initially NULL<span class="p">;</span> not assigned any special meaning
comments     Initially NULL<span class="p">;</span> not assigned any special meaning
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">fingerprint</span></code> column is the true primary key for a class of
queries.  The <code class="docutils literal notranslate"><span class="pre">checksum</span></code> is just a cryptographic hash of this value, which
provides a shorter value that is very likely to also be unique.</p>
<p>After parsing and aggregating events, your table should contain a row for each
fingerprint.  This option depends on <code class="docutils literal notranslate"><span class="pre">--group-by</span> <span class="pre">fingerprint</span></code> (which is the
default).  It will not work otherwise.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-run-time">
<code class="sig-name descname">--run-time</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-run-time" title="Permalink to this definition">¶</a></dt>
<dd><p>type: time</p>
<p>How long to run for each <a class="reference internal" href="#cmdoption-mariadb-query-digest-iterations"><code class="xref std std-option docutils literal notranslate"><span class="pre">--iterations</span></code></a>.  The default is to run forever
(you can interrupt with CTRL-C).  Because <a class="reference internal" href="#cmdoption-mariadb-query-digest-iterations"><code class="xref std std-option docutils literal notranslate"><span class="pre">--iterations</span></code></a> defaults to 1,
if you only specify <a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a>, <strong class="program">mariadb-query-digest</strong> runs for that amount of
time and then exits.  The two options are specified together to do
collect-and-report cycles.  For example, specifying <a class="reference internal" href="#cmdoption-mariadb-query-digest-iterations"><code class="xref std std-option docutils literal notranslate"><span class="pre">--iterations</span></code></a> <code class="docutils literal notranslate"><span class="pre">4</span></code>
<a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> <code class="docutils literal notranslate"><span class="pre">15m</span></code> with a continuous input (like STDIN or
<a class="reference internal" href="#cmdoption-mariadb-query-digest-processlist"><code class="xref std std-option docutils literal notranslate"><span class="pre">--processlist</span></code></a>) will cause <strong class="program">mariadb-query-digest</strong> to run for 1 hour
(15 minutes x 4), reporting four times, once at each 15 minute interval.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-run-time-mode">
<code class="sig-name descname">--run-time-mode</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-run-time-mode" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string; default: clock</p>
<p>Set what the value of <a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> operates on.  Following are the possible
values for this option:</p>
<p>clock</p>
<blockquote>
<div><p><a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> specifies an amount of real clock time during which the tool
should run for each <a class="reference internal" href="#cmdoption-mariadb-query-digest-iterations"><code class="xref std std-option docutils literal notranslate"><span class="pre">--iterations</span></code></a>.</p>
</div></blockquote>
<p>event</p>
<blockquote>
<div><p><a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> specifies an amount of log time.  Log time is determined by
timestamps in the log.  The first timestamp seen is remembered, and each
timestamp after that is compared to the first to determine how much log time
has passed.  For example, if the first timestamp seen is <code class="docutils literal notranslate"><span class="pre">12:00:00</span></code> and the
next is <code class="docutils literal notranslate"><span class="pre">12:01:30</span></code>, that is 1 minute and 30 seconds of log time.  The tool
will read events until the log time is greater than or equal to the specified
<a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> value.</p>
<p>Since timestamps in logs are not always printed, or not always printed
frequently, this mode varies in accuracy.</p>
</div></blockquote>
<p>interval</p>
<blockquote>
<div><p><a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> specifies interval boundaries of log time into which events
are divided and reports are generated.  This mode is different from the
others because it doesn’t specify how long to run.  The value of
<a class="reference internal" href="#cmdoption-mariadb-query-digest-run-time"><code class="xref std std-option docutils literal notranslate"><span class="pre">--run-time</span></code></a> must be an interval that divides evenly into minutes, hours
or days.  For example, <code class="docutils literal notranslate"><span class="pre">5m</span></code> divides evenly into hours (60/5=12, so 12
5 minutes intervals per hour) but <code class="docutils literal notranslate"><span class="pre">7m</span></code> does not (60/7=8.6).</p>
<p>Specifying <code class="docutils literal notranslate"><span class="pre">--run-time-mode</span> <span class="pre">interval</span> <span class="pre">--run-time</span> <span class="pre">30m</span> <span class="pre">--iterations</span> <span class="pre">0</span></code> is
similar to specifying <code class="docutils literal notranslate"><span class="pre">--run-time-mode</span> <span class="pre">clock</span> <span class="pre">--run-time</span> <span class="pre">30m</span> <span class="pre">--iterations</span> <span class="pre">0</span></code>.
In the latter case, <strong class="program">mariadb-query-digest</strong> will run forever, producing reports every
30 minutes, but this only works effectively with  continuous inputs like
STDIN and the processlist.  For fixed inputs, like log files, the former
example produces multiple reports by dividing the log into 30 minutes
intervals based on timestamps.</p>
<p>Intervals are calculated from the zeroth second/minute/hour in which a
timestamp occurs, not from whatever time it specifies.  For example,
with 30 minute intervals and a timestamp of <code class="docutils literal notranslate"><span class="pre">12:10:30</span></code>, the interval
is <em>not</em> <code class="docutils literal notranslate"><span class="pre">12:10:30</span></code> to <code class="docutils literal notranslate"><span class="pre">12:40:30</span></code>, it is <code class="docutils literal notranslate"><span class="pre">12:00:00</span></code> to <code class="docutils literal notranslate"><span class="pre">12:29:59</span></code>.
Or, with 1 hour intervals, it is <code class="docutils literal notranslate"><span class="pre">12:00:00</span></code> to <code class="docutils literal notranslate"><span class="pre">12:59:59</span></code>.
When a new timestamp exceeds the interval, a report is printed, and the
next interval is recalculated based on the new timestamp.</p>
<p>Since <a class="reference internal" href="#cmdoption-mariadb-query-digest-iterations"><code class="xref std std-option docutils literal notranslate"><span class="pre">--iterations</span></code></a> is 1 by default, you probably want to specify
a new value else <strong class="program">mariadb-query-digest</strong> will only get and report on the first
interval from the log since 1 interval = 1 iteration.  If you want to
get and report every interval in a log, specify <a class="reference internal" href="#cmdoption-mariadb-query-digest-iterations"><code class="xref std std-option docutils literal notranslate"><span class="pre">--iterations</span></code></a> <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
</div></blockquote>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-sample">
<code class="sig-name descname">--sample</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-sample" title="Permalink to this definition">¶</a></dt>
<dd><p>type: int</p>
<p>Filter out all but the first N occurrences of each query.  The queries are
filtered on the first value in <a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a>, so by default, this will filter
by query fingerprint.  For example, <code class="docutils literal notranslate"><span class="pre">--sample</span> <span class="pre">2</span></code> will permit two sample queries
for each fingerprint.  Useful in conjunction with <code class="docutils literal notranslate"><span class="pre">--output</span> <span class="pre">slowlog</span></code> to print
the queries.  You probably want to set <code class="docutils literal notranslate"><span class="pre">--no-report</span></code> to avoid the overhead of
aggregating and reporting if you’re just using this to print out samples of
queries.  A complete example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>:program:<span class="sb">`</span>mariadb-query-digest<span class="sb">`</span> --sample <span class="m">2</span> --no-report --output slowlog slow.log
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-slave-user">
<code class="sig-name descname">--slave-user</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-slave-user" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>Sets the user to be used to connect to the slaves.
This parameter allows you to have a different user with less privileges on the
slaves but that user must exist on all slaves.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-slave-password">
<code class="sig-name descname">--slave-password</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-slave-password" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>Sets the password to be used to connect to the slaves.
It can be used with –slave-user and the password for the user must be the same
on all slaves.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-set-vars">
<code class="sig-name descname">--set-vars</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-set-vars" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Array</p>
<p>Set the MariaDB variables in this comma-separated list of <code class="docutils literal notranslate"><span class="pre">variable=value</span></code> pairs.</p>
<p>By default, the tool sets:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">wait_timeout</span><span class="o">=</span><span class="m">10000</span>
</pre></div>
</div>
<p>Variables specified on the command line override these defaults.  For
example, specifying <code class="docutils literal notranslate"><span class="pre">--set-vars</span> <span class="pre">wait_timeout=500</span></code> overrides the defaultvalue of <code class="docutils literal notranslate"><span class="pre">10000</span></code>.</p>
<p>The tool prints a warning and continues if a variable cannot be set.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-show-all">
<code class="sig-name descname">--show-all</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-show-all" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Hash</p>
<p>Show all values for these attributes.</p>
<p>By default <strong class="program">mariadb-query-digest</strong> only shows as many of an attribute’s value that
fit on a single line.  This option allows you to specify attributes for which
all values will be shown (line width is ignored).  This only works for
attributes with string values like user, host, db, etc.  Multiple attributes
can be specified, comma-separated.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-since">
<code class="sig-name descname">--since</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-since" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>Parse only queries newer than this value (parse queries since this date).</p>
<p>This option allows you to ignore queries older than a certain value and parse
only those queries which are more recent than the value.  The value can be
several types:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>* Simple <span class="nb">time</span> value N with optional suffix: N<span class="o">[</span>shmd<span class="o">]</span>, where
  <span class="nv">s</span><span class="o">=</span>seconds, <span class="nv">h</span><span class="o">=</span>hours, <span class="nv">m</span><span class="o">=</span>minutes, <span class="nv">d</span><span class="o">=</span>days <span class="o">(</span>default s <span class="k">if</span> no suffix
  given<span class="o">)</span><span class="p">;</span> this is like saying <span class="s2">&quot;since N[shmd] ago&quot;</span>
* Full date with optional hours:minutes:seconds:
  YYYY-MM-DD <span class="o">[</span>HH:MM:SS<span class="o">]</span>
* Short, MariaDB-style date:
  YYMMDD <span class="o">[</span>HH:MM:SS<span class="o">]</span>
* Any <span class="nb">time</span> expression evaluated by MariaDB:
  CURRENT_DATE - INTERVAL <span class="m">7</span> DAY
</pre></div>
</div>
<p>If you give a MariaDB time expression, and you have not also specified a DSN
for <a class="reference internal" href="#cmdoption-mariadb-query-digest-explain"><code class="xref std std-option docutils literal notranslate"><span class="pre">--explain</span></code></a>, <a class="reference internal" href="#cmdoption-mariadb-query-digest-processlist"><code class="xref std std-option docutils literal notranslate"><span class="pre">--processlist</span></code></a>, or <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a>, then you must specify
a DSN on the command line so that <strong class="program">mariadb-query-digest</strong> can connect to MariaDB to
evaluate the expression.</p>
<p>The MariaDB time expression is wrapped inside a query like
“SELECT UNIX_TIMESTAMP(&lt;expression&gt;)”, so be sure that the expression is
valid inside this query.  For example, do not use UNIX_TIMESTAMP() because
UNIX_TIMESTAMP(UNIX_TIMESTAMP()) returns 0.</p>
<p>Events are assumed to be in chronological: older events at the beginning of
the log and newer events at the end of the log.  <a class="reference internal" href="#cmdoption-mariadb-query-digest-since"><code class="xref std std-option docutils literal notranslate"><span class="pre">--since</span></code></a> is strict: it
ignores all queries until one is found that is new enough.  Therefore, if
the query events are not consistently timestamped, some may be ignored which
are actually new enough.</p>
<p>See also <a class="reference internal" href="#cmdoption-mariadb-query-digest-until"><code class="xref std std-option docutils literal notranslate"><span class="pre">--until</span></code></a>.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-socket">
<code class="sig-name descname">--socket</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-socket" title="Permalink to this definition">¶</a></dt>
<dd><p>short form: -S; type: string</p>
<p>Socket file to use for connection.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-timeline">
<code class="sig-name descname">--timeline</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-timeline" title="Permalink to this definition">¶</a></dt>
<dd><p>Show a timeline of events.</p>
<p>This option makes <strong class="program">mariadb-query-digest</strong> print another kind of report: a timeline of
the events.  Each query is still grouped and aggregate into classes according to
<a class="reference internal" href="#cmdoption-mariadb-query-digest-group-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--group-by</span></code></a>, but then they are printed in chronological order.  The timeline
report prints out the timestamp, interval, count and value of each classes.</p>
<p>If all you want is the timeline report, then specify <code class="docutils literal notranslate"><span class="pre">--no-report</span></code> to
suppress the default query analysis report.  Otherwise, the timeline report
will be printed at the end before the response-time profile
(see <a class="reference internal" href="#cmdoption-mariadb-query-digest-report-format"><code class="xref std std-option docutils literal notranslate"><span class="pre">--report-format</span></code></a> and “OUTPUT”).</p>
<p>For example, this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>:program:<span class="sb">`</span>mariadb-query-digest<span class="sb">`</span> /path/to/log --group-by distill --timeline
</pre></div>
</div>
<p>will print something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ########################################################</span>
<span class="c1"># distill report</span>
<span class="c1"># ########################################################</span>
<span class="c1"># 2009-07-25 11:19:27 1+00:00:01   2 SELECT foo</span>
<span class="c1"># 2009-07-27 11:19:30      00:01   2 SELECT bar</span>
<span class="c1"># 2009-07-27 11:30:00 1+06:30:00   2 SELECT foo</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-type">
<code class="sig-name descname">--type</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-type" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Array; default: slowlog</p>
<p>The type of input to parse.  The permitted types are</p>
<p>binlog</p>
<blockquote>
<div><p>Parse a binary log file that has first been converted to text using mariadb-binlog.</p>
<p>For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mariadb-binlog mariadb-bin.000441 &gt; mariadb-bin.000441.txt

:program:<span class="sb">`</span>mariadb-query-digest<span class="sb">`</span> --type binlog mariadb-bin.000441.txt
</pre></div>
</div>
</div></blockquote>
<p>genlog</p>
<blockquote>
<div><p>Parse a MariaDB general log file.  General logs lack a lot of “ATTRIBUTES”,
notably <code class="docutils literal notranslate"><span class="pre">Query_time</span></code>.  The default <a class="reference internal" href="#cmdoption-mariadb-query-digest-order-by"><code class="xref std std-option docutils literal notranslate"><span class="pre">--order-by</span></code></a> for general logs
changes to <code class="docutils literal notranslate"><span class="pre">Query_time:cnt</span></code>.</p>
</div></blockquote>
<p>slowlog</p>
<blockquote>
<div><p>Parse a log file in any variation of MariaDB slow log format.</p>
</div></blockquote>
<p>tcpdump</p>
<blockquote>
<div><p>Inspect network packets and decode the MariaDB client protocol, extracting queries
and responses from it.</p>
<p><strong class="program">mariadb-query-digest</strong> does not actually watch the network (i.e. it does NOT “sniff
packets”).  Instead, it’s just parsing the output of tcpdump.  You are
responsible for generating this output; <strong class="program">mariadb-query-digest</strong> does not do it for you.
Then you send this to <strong class="program">mariadb-query-digest</strong> as you would any log file: as files on the
command line or to STDIN.</p>
<p>The parser expects the input to be formatted with the following options: <code class="docutils literal notranslate"><span class="pre">-x</span> <span class="pre">-n</span>
<span class="pre">-q</span> <span class="pre">-tttt</span></code>.  For example, if you want to capture output from your local machine,
you can do something like the following (the port must come last on FreeBSD):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tcpdump -s <span class="m">65535</span> -x -nn -q -tttt -i any -c <span class="m">1000</span> port <span class="m">3306</span> <span class="se">\</span>
  &gt; mariadb.tcp.txt
:program:<span class="sb">`</span>mariadb-query-digest<span class="sb">`</span> --type tcpdump mariadb.tcp.txt
</pre></div>
</div>
<p>The other tcpdump parameters, such as -s, -c, and -i, are up to you.  Just make
sure the output looks like this (there is a line break in the first line to
avoid man-page problems):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2009</span>-04-12 <span class="m">09</span>:50:16.804849 IP <span class="m">127</span>.0.0.1.42167
       &gt; <span class="m">127</span>.0.0.1.3306: tcp <span class="m">37</span>
    0x0000:  <span class="m">4508</span> <span class="m">0059</span> 6eb2 <span class="m">4000</span> <span class="m">4006</span> cde2 7f00 <span class="m">0001</span>
    0x0010:  ....
</pre></div>
</div>
<p>Remember tcpdump has a handy -c option to stop after it captures some number of
packets!  That’s very useful for testing your tcpdump command.  Note that
tcpdump can’t capture traffic on a Unix socket.  Read
<a class="reference external" href="http://bugs.mysql.com/bug.php?id=31577">http://bugs.mysql.com/bug.php?id=31577</a> if you’re confused about this.</p>
<p>Devananda Van Der Veen explained on the MySQL Performance Blog how to capture
traffic without dropping packets on busy servers.  Dropped packets cause
<strong class="program">mariadb-query-digest</strong> to miss the response to a request, then see the response to a
later request and assign the wrong execution time to the query.  You can change
the filter to something like the following to help capture a subset of the
queries.  (See <a class="reference external" href="http://www.mysqlperformanceblog.com/?p=6092">http://www.mysqlperformanceblog.com/?p=6092</a> for details.)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tcpdump -i any -s <span class="m">65535</span> -x -n -q -tttt <span class="se">\</span>
   <span class="s1">&#39;port 3306 and tcp[1] &amp; 7 == 2 and tcp[3] &amp; 7 == 2&#39;</span>
</pre></div>
</div>
<p>All MariaDB servers running on port 3306 are automatically detected in the
tcpdump output.  Therefore, if the tcpdump out contains packets from
multiple servers on port 3306 (for example, 10.0.0.1:3306, 10.0.0.2:3306,
etc.), all packets/queries from all these servers will be analyzed
together as if they were one server.</p>
<p>If you’re analyzing traffic for a MariaDB server that is not running on port
3306, see <a class="reference internal" href="#cmdoption-mariadb-query-digest-watch-server"><code class="xref std std-option docutils literal notranslate"><span class="pre">--watch-server</span></code></a>.</p>
<p>Also note that <strong class="program">mariadb-query-digest</strong> may fail to report the database for queries
when parsing tcpdump output.  The database is discovered only in the initial
connect events for a new client or when &lt;USE db&gt; is executed.  If the tcpdump
output contains neither of these, then <strong class="program">mariadb-query-digest</strong> cannot discover the
database.</p>
<p>Server-side prepared statements are supported.  SSL-encrypted traffic cannot be
inspected and decoded.</p>
</div></blockquote>
<p>rawlog</p>
<blockquote>
<div><p>Raw logs are not MariaDB logs but simple text files with one SQL statement
per line, like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>SELECT c FROM t WHERE <span class="nv">id</span><span class="o">=</span><span class="m">1</span>
/* Hello, world! */ SELECT * FROM t2 LIMIT <span class="m">1</span>
INSERT INTO t <span class="o">(</span>a, b<span class="o">)</span> VALUES <span class="o">(</span><span class="s1">&#39;foo&#39;</span>, <span class="s1">&#39;bar&#39;</span><span class="o">)</span>
INSERT INTO t SELECT * FROM monkeys
</pre></div>
</div>
<p>Since raw logs do not have any metrics, many options and features of
<strong class="program">mariadb-query-digest</strong> do not work with them.</p>
<p>One use case for raw logs is ranking queries by count when the only
information available is a list of queries, from polling <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">PROCESSLIST</span></code>
for example.</p>
</div></blockquote>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-until">
<code class="sig-name descname">--until</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-until" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>Parse only queries older than this value (parse queries until this date).</p>
<p>This option allows you to ignore queries newer than a certain value and parse
only those queries which are older than the value.  The value can be one of
the same types listed for <a class="reference internal" href="#cmdoption-mariadb-query-digest-since"><code class="xref std std-option docutils literal notranslate"><span class="pre">--since</span></code></a>.</p>
<p>Unlike <a class="reference internal" href="#cmdoption-mariadb-query-digest-since"><code class="xref std std-option docutils literal notranslate"><span class="pre">--since</span></code></a>, <a class="reference internal" href="#cmdoption-mariadb-query-digest-until"><code class="xref std std-option docutils literal notranslate"><span class="pre">--until</span></code></a> is not strict: all queries are parsed until
one has a timestamp that is equal to or greater than <a class="reference internal" href="#cmdoption-mariadb-query-digest-until"><code class="xref std std-option docutils literal notranslate"><span class="pre">--until</span></code></a>.  Then
all subsequent queries are ignored.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-user">
<code class="sig-name descname">--user</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-user" title="Permalink to this definition">¶</a></dt>
<dd><p>short form: -u; type: string</p>
<p>User for login if not current user.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-variations">
<code class="sig-name descname">--variations</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-variations" title="Permalink to this definition">¶</a></dt>
<dd><p>type: Array</p>
<p>Report the number of variations in these attributes’ values.</p>
<p>Variations show how many distinct values an attribute had within a class.
The usual value for this option is <code class="docutils literal notranslate"><span class="pre">arg</span></code> which shows how many distinct queries
were in the class.  This can be useful to determine a query’s cacheability.</p>
<p>Distinct values are determined by CRC32 checksums of the attributes’ values.
These checksums are reported in the query report for attributes specified by
this option, like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># arg crc      109 (1/25%), 144 (1/25%)... 2 more</span>
</pre></div>
</div>
<p>In that class there were 4 distinct queries.  The checksums of the first two
variations are shown, and each one occurred once (or, 25% of the time).</p>
<p>The counts of distinct variations is approximate because only 1,000 variations
are saved.  The mod (%) 1000 of the full CRC32 checksum is saved, so some
distinct checksums are treated as equal.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-version">
<code class="sig-name descname">--version</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-version" title="Permalink to this definition">¶</a></dt>
<dd><p>Show version and exit.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-no-vertical-format">
<code class="sig-name descname">--[no]vertical-format</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-no-vertical-format" title="Permalink to this definition">¶</a></dt>
<dd><p>default: yes</p>
<p>Output a trailing “G” in the reported SQL queries.</p>
<p>This makes the mariadb client display the result using vertical format.
Non-native MariaDB clients like phpMyAdmin do not support this.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-mariadb-query-digest-watch-server">
<code class="sig-name descname">--watch-server</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-mariadb-query-digest-watch-server" title="Permalink to this definition">¶</a></dt>
<dd><p>type: string</p>
<p>This option tells <strong class="program">mariadb-query-digest</strong> which server IP address and port (like
“10.0.0.1:3306”) to watch when parsing tcpdump (for <a class="reference internal" href="#cmdoption-mariadb-query-digest-type"><code class="xref std std-option docutils literal notranslate"><span class="pre">--type</span></code></a> tcpdump);
all other servers are ignored.  If you don’t specify it,
<strong class="program">mariadb-query-digest</strong> watches all servers by looking for any IP address using port
3306 or “mariadb”.  If you’re watching a server with a non-standard port, this
won’t work, so you must specify the IP address and port to watch.</p>
<p>If you want to watch a mix of servers, some running on standard port 3306
and some running on non-standard ports, you need to create separate
tcpdump outputs for the non-standard port servers and then specify this
option for each.  At present <strong class="program">mariadb-query-digest</strong> cannot auto-detect servers on
port 3306 and also be told to watch a server on a non-standard port.</p>
</dd></dl>

</div>
<div class="section" id="dsn-options">
<h2>DSN OPTIONS<a class="headerlink" href="#dsn-options" title="Permalink to this headline">¶</a></h2>
<p>These DSN options are used to create a DSN.  Each option is given like
<code class="docutils literal notranslate"><span class="pre">option=value</span></code>.  The options are case-sensitive, so P and p are not the
same option.  There cannot be whitespace before or after the <code class="docutils literal notranslate"><span class="pre">=</span></code> and
if the value contains whitespace it must be quoted.  DSN options are
comma-separated.  See the mariadb-tools manpage for full details.</p>
<ul class="simple">
<li><p>A</p></li>
</ul>
<blockquote>
<div><p>dsn: charset; copy: yes</p>
<p>Default character set.</p>
</div></blockquote>
<ul class="simple">
<li><p>D</p></li>
</ul>
<blockquote>
<div><p>dsn: database; copy: yes</p>
<p>Default database to use when connecting to MariaDB.</p>
</div></blockquote>
<ul class="simple">
<li><p>F</p></li>
</ul>
<blockquote>
<div><p>dsn: mysql_read_default_file; copy: yes</p>
<p>Only read default options from the given file.</p>
</div></blockquote>
<ul class="simple">
<li><p>h</p></li>
</ul>
<blockquote>
<div><p>dsn: host; copy: yes</p>
<p>Connect to host.</p>
</div></blockquote>
<ul class="simple">
<li><p>p</p></li>
</ul>
<blockquote>
<div><p>dsn: password; copy: yes</p>
<p>Password to use when connecting.
If password contains commas they must be escaped with a backslash: “exam,ple”</p>
</div></blockquote>
<ul class="simple">
<li><p>P</p></li>
</ul>
<blockquote>
<div><p>dsn: port; copy: yes</p>
<p>Port number to use for connection.</p>
</div></blockquote>
<ul class="simple">
<li><p>S</p></li>
</ul>
<blockquote>
<div><p>dsn: mysql_socket; copy: yes</p>
<p>Socket file to use for connection.</p>
</div></blockquote>
<ul class="simple">
<li><p>t</p></li>
</ul>
<blockquote>
<div><p>The <a class="reference internal" href="#cmdoption-mariadb-query-digest-review"><code class="xref std std-option docutils literal notranslate"><span class="pre">--review</span></code></a> or <a class="reference internal" href="#cmdoption-mariadb-query-digest-history"><code class="xref std std-option docutils literal notranslate"><span class="pre">--history</span></code></a> table.</p>
</div></blockquote>
<ul class="simple">
<li><p>u</p></li>
</ul>
<blockquote>
<div><p>dsn: user; copy: yes</p>
<p>User for login if not current user.</p>
</div></blockquote>
</div>
<div class="section" id="environment">
<h2>ENVIRONMENT<a class="headerlink" href="#environment" title="Permalink to this headline">¶</a></h2>
<p>The environment variable <code class="docutils literal notranslate"><span class="pre">PTDEBUG</span></code> enables verbose debugging output to STDERR.
To enable debugging and capture all output to a file, run the tool like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PTDEBUG</span><span class="o">=</span><span class="m">1</span> mariadb-query-digest ... &gt; FILE <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</pre></div>
</div>
<p>Be careful: debugging output is voluminous and can generate several megabytes
of output.</p>
</div>
<div class="section" id="system-requirements">
<h2>SYSTEM REQUIREMENTS<a class="headerlink" href="#system-requirements" title="Permalink to this headline">¶</a></h2>
<p>You need Perl, DBI, DBD::mysql, and some core packages that ought to be
installed in any reasonably new version of Perl.</p>
</div>
<div class="section" id="attributes-reference">
<h2>ATTRIBUTES REFERENCE<a class="headerlink" href="#attributes-reference" title="Permalink to this headline">¶</a></h2>
<p>Events may have the following attributes.  If writing a <a class="reference internal" href="#cmdoption-mariadb-query-digest-filter"><code class="xref std std-option docutils literal notranslate"><span class="pre">--filter</span></code></a>,
be sure to check that an attribute is defined in each event before
using it, else the filter code may crash the tool with a
“use of uninitialized value” error.</p>
<p>You can dump event attributes for any input like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mariadb-query-digest                  <span class="se">\</span>
    slow.log                       <span class="se">\</span>
    --filter <span class="s1">&#39;print Dumper $event&#39;</span> <span class="se">\</span>
    --no-report                    <span class="se">\</span>
    --sample <span class="m">1</span>
</pre></div>
</div>
<p>That will produce a lot of output with “attribute =&gt; value” pairs like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$VAR1</span> <span class="o">=</span> <span class="o">{</span>
  <span class="nv">Query_time</span> <span class="o">=</span>&gt; <span class="s1">&#39;0.033384&#39;</span>,
  <span class="nv">Rows_examined</span> <span class="o">=</span>&gt; <span class="s1">&#39;0&#39;</span>,
  <span class="nv">Rows_sent</span> <span class="o">=</span>&gt; <span class="s1">&#39;0&#39;</span>,
  <span class="nv">Thread_id</span> <span class="o">=</span>&gt; <span class="s1">&#39;10&#39;</span>,
  <span class="nv">Tmp_table</span> <span class="o">=</span>&gt; <span class="s1">&#39;No&#39;</span>,
  <span class="nv">Tmp_table_on_disk</span> <span class="o">=</span>&gt; <span class="s1">&#39;No&#39;</span>,
  <span class="nv">arg</span> <span class="o">=</span>&gt; <span class="s1">&#39;SELECT col FROM tbl WHERE id=5&#39;</span>,
  <span class="nv">bytes</span> <span class="o">=</span>&gt; <span class="m">103</span>,
  <span class="nv">cmd</span> <span class="o">=</span>&gt; <span class="s1">&#39;Query&#39;</span>,
  <span class="nv">db</span> <span class="o">=</span>&gt; <span class="s1">&#39;db1&#39;</span>,
  <span class="nv">fingerprint</span> <span class="o">=</span>&gt; <span class="s1">&#39;select col from tbl where id=?&#39;</span>,
  <span class="nv">host</span> <span class="o">=</span>&gt; <span class="s1">&#39;&#39;</span>,
  <span class="nv">pos_in_log</span> <span class="o">=</span>&gt; <span class="m">1334</span>,
  <span class="nv">ts</span> <span class="o">=</span>&gt; <span class="s1">&#39;071218 11:48:27&#39;</span>,
  <span class="nv">user</span> <span class="o">=</span>&gt; <span class="s1">&#39;[SQL_SLAVE]&#39;</span>
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="common">
<h2>COMMON<a class="headerlink" href="#common" title="Permalink to this headline">¶</a></h2>
<p>These attribute are common to all input <a class="reference internal" href="#cmdoption-mariadb-query-digest-type"><code class="xref std std-option docutils literal notranslate"><span class="pre">--type</span></code></a> and <a class="reference internal" href="#cmdoption-mariadb-query-digest-processlist"><code class="xref std std-option docutils literal notranslate"><span class="pre">--processlist</span></code></a>,
except where noted.</p>
<p>arg</p>
<blockquote>
<div><p>The query text, or the command for admin commands like <code class="docutils literal notranslate"><span class="pre">Ping</span></code>.</p>
</div></blockquote>
<p>bytes</p>
<blockquote>
<div><p>The byte length of the <code class="docutils literal notranslate"><span class="pre">arg</span></code>.</p>
</div></blockquote>
<p>cmd</p>
<blockquote>
<div><p>“Query” or “Admin”.</p>
</div></blockquote>
<p>db</p>
<blockquote>
<div><p>The current database.  The value comes from USE database statements.
By default, <code class="docutils literal notranslate"><span class="pre">Schema</span></code> is an alias which is automatically
changed to <code class="docutils literal notranslate"><span class="pre">db</span></code>; see <a class="reference internal" href="#cmdoption-mariadb-query-digest-attribute-aliases"><code class="xref std std-option docutils literal notranslate"><span class="pre">--attribute-aliases</span></code></a>.</p>
</div></blockquote>
<p>fingerprint</p>
<blockquote>
<div><p>An abstracted form of the query.  See “FINGERPRINTS”.</p>
</div></blockquote>
<p>host</p>
<blockquote>
<div><p>Client host which executed the query.</p>
</div></blockquote>
<p>pos_in_log</p>
<blockquote>
<div><p>The byte offset of the event in the log or tcpdump,
except for <a class="reference internal" href="#cmdoption-mariadb-query-digest-processlist"><code class="xref std std-option docutils literal notranslate"><span class="pre">--processlist</span></code></a>.</p>
</div></blockquote>
<p>Query_time</p>
<blockquote>
<div><p>The total time the query took, including lock time.</p>
</div></blockquote>
<p>ts</p>
<blockquote>
<div><p>The timestamp of when the query ended.</p>
</div></blockquote>
</div>
<div class="section" id="slow-general-and-binary-logs">
<h2>SLOW, GENERAL, AND BINARY LOGS<a class="headerlink" href="#slow-general-and-binary-logs" title="Permalink to this headline">¶</a></h2>
<p>Events have all available attributes from the log file.  Therefore, you only
need to look at the log file to see which events are available, but remember:
not all events have the same attributes.</p>
</div>
<div class="section" id="tcpdump">
<h2>TCPDUMP<a class="headerlink" href="#tcpdump" title="Permalink to this headline">¶</a></h2>
<p>These attributes are available when parsing <a class="reference internal" href="#cmdoption-mariadb-query-digest-type"><code class="xref std std-option docutils literal notranslate"><span class="pre">--type</span></code></a> tcpdump.</p>
<p>Error_no</p>
<blockquote>
<div><p>The MariaDB error number if the query caused an error.</p>
</div></blockquote>
<p>ip</p>
<blockquote>
<div><p>The client’s IP address.  Certain log files may also contain this attribute.</p>
</div></blockquote>
<p>No_good_index_used</p>
<blockquote>
<div><p>Yes or No if no good index existed for the query (flag set by server).</p>
</div></blockquote>
<p>No_index_used</p>
<blockquote>
<div><p>Yes or No if the query did not use any index (flag set by server).</p>
</div></blockquote>
<p>port</p>
<blockquote>
<div><p>The client’s port number.</p>
</div></blockquote>
<p>Warning_count</p>
<blockquote>
<div><p>The number of warnings, as otherwise shown by <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">WARNINGS</span></code>.</p>
</div></blockquote>
</div>
<div class="section" id="processlist">
<h2>PROCESSLIST<a class="headerlink" href="#processlist" title="Permalink to this headline">¶</a></h2>
<p>If using <a class="reference internal" href="#cmdoption-mariadb-query-digest-processlist"><code class="xref std std-option docutils literal notranslate"><span class="pre">--processlist</span></code></a>, an <code class="docutils literal notranslate"><span class="pre">id</span></code> attribute is available for
the process ID, in addition to the common attributes.</p>
</div>
<div class="section" id="authors">
<h2>AUTHORS<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<p>Baron Schwartz, Daniel Nichter, and Brian Fraser</p>
</div>
<div class="section" id="about-this-mariadb-tool">
<h2>ABOUT THIS MARIADB TOOL<a class="headerlink" href="#about-this-mariadb-tool" title="Permalink to this headline">¶</a></h2>
<p>This tool is part of MariaDB client tools. This MariaDB Tool was forked from
Percona Toolkit’s pt-query-digest in November, 2019.  Percona Toolkit was
forked from two projects in June, 2011: Maatkit and Aspersa.  Those projects
were created by Baron Schwartz and primarily developed by him and Daniel
Nichter.</p>
</div>
<div class="section" id="copyright-license-and-warranty">
<h2>COPYRIGHT, LICENSE, AND WARRANTY<a class="headerlink" href="#copyright-license-and-warranty" title="Permalink to this headline">¶</a></h2>
<p>This program is copyright 2019 MariaDB Corporation and/or its affiliates,
2011-2018 Percona LLC and/or its affiliates, 2010-2011 Baron Schwartz.</p>
<p>THIS PROGRAM IS PROVIDED “AS IS” AND WITHOUT ANY EXPRESS OR IMPLIED
WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</p>
<p>This program is free software; you can redistribute it and/or modify it under
the terms of the GNU General Public License as published by the Free Software
Foundation, version 2; OR the Perl Artistic License.  On UNIX and similar
systems, you can issue `man perlgpl’ or `man perlartistic’ to read these
licenses.</p>
<p>You should have received a copy of the GNU General Public License along with
this program; if not, write to the Free Software Foundation, Inc., 59 Temple
Place, Suite 330, Boston, MA  02111-1307  USA.</p>
</div>
<div class="section" id="version">
<h2>VERSION<a class="headerlink" href="#version" title="Permalink to this headline">¶</a></h2>
<p><strong class="program">mariadb-query-digest</strong> 3.3.1</p>
</div>
</div>


          </div>
        </div>
    <div class="related row">
      
      <ul class="nav nav-pills">
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="mariadb-schema-change.html" title="mariadb-schema-change"
             >next</a></li>
        <li class="right" >
          <a href="mariadb-kill.html" title="mariadb-kill"
             >previous</a></li>
        <li><a href="index.html">MariaDB Tools</a></li> 
      </ul>
    </div>
      </div>
      <div class="sphinxsidebar  col-md-3 col-md-pull-9">
        <div class="sphinxsidebarwrapper">
  
          {@ product_logo @}          

          {@ product_pdf_download @}
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#"><strong class="program">mariadb-query-digest</strong></a><ul>
<li><a class="reference internal" href="#name">NAME</a></li>
<li><a class="reference internal" href="#synopsis">SYNOPSIS</a><ul>
<li><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#risks">RISKS</a></li>
<li><a class="reference internal" href="#description">DESCRIPTION</a></li>
<li><a class="reference internal" href="#attributes">ATTRIBUTES</a></li>
<li><a class="reference internal" href="#output">OUTPUT</a></li>
<li><a class="reference internal" href="#query-review">QUERY REVIEW</a></li>
<li><a class="reference internal" href="#fingerprints">FINGERPRINTS</a></li>
<li><a class="reference internal" href="#options">OPTIONS</a></li>
<li><a class="reference internal" href="#dsn-options">DSN OPTIONS</a></li>
<li><a class="reference internal" href="#environment">ENVIRONMENT</a></li>
<li><a class="reference internal" href="#system-requirements">SYSTEM REQUIREMENTS</a></li>
<li><a class="reference internal" href="#attributes-reference">ATTRIBUTES REFERENCE</a></li>
<li><a class="reference internal" href="#common">COMMON</a></li>
<li><a class="reference internal" href="#slow-general-and-binary-logs">SLOW, GENERAL, AND BINARY LOGS</a></li>
<li><a class="reference internal" href="#tcpdump">TCPDUMP</a></li>
<li><a class="reference internal" href="#processlist">PROCESSLIST</a></li>
<li><a class="reference internal" href="#authors">AUTHORS</a></li>
<li><a class="reference internal" href="#about-this-mariadb-tool">ABOUT THIS MARIADB TOOL</a></li>
<li><a class="reference internal" href="#copyright-license-and-warranty">COPYRIGHT, LICENSE, AND WARRANTY</a></li>
<li><a class="reference internal" href="#version">VERSION</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="mariadb-kill.html"
                        title="previous chapter"><strong class="program">mariadb-kill</strong></a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mariadb-schema-change.html"
                        title="next chapter"><strong class="program">mariadb-schema-change</strong></a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">jQuery(document).ready(function(){ jQuery('#searchbox').show(0); });</script>
          {@ product_series @}
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <!-- div class="footer">
        &copy; Copyright 2020, MariaDB Corporation and/or its affiliates.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 2.3.1.
    </div -->
  </div>
  </body>
